# ns-3 CI/CD script with the code-linting stage
#
# Contains jobs to check the ns-3 coding style and perform lint checking.

check-style-clang-format:
  stage: code-linting
  image: ubuntu:latest
  before_script:
    - apt update
    - DEBIAN_FRONTEND=noninteractive apt install -y
      python3
      clang-format-14
  script:
    - python3 utils/check-style-clang-format.py .
  timeout: 3h

.base-clang-tidy:
  stage: code-linting
  image: ubuntu:latest
  before_script:
    - apt update
    - DEBIAN_FRONTEND=noninteractive apt install -y
      clang cmake
      clang-tidy-14
      python3 python3-pip
      libboost-all-dev
      libgtk-3-dev
      gsl-bin libgsl-dev libgsl27
      libopenmpi-dev
      libsqlite3-dev
      ssh git
    - pip3 install cppyy
    - ./ns3 configure -d debug
      --enable-clang-tidy
      --enable-examples --enable-tests
      --enable-asserts
      --enable-mpi
      --enable-python-bindings
  variables:
    MPI_CI: 1
  artifacts:
    paths:
      - clang-tidy-errors.log
    when: on_failure
  timeout: 3h

clang-tidy:
  extends: .base-clang-tidy
  only:
    variables:
      - $RELEASE == "weekly"
      - $RELEASE == "daily"
  script:
    - run-clang-tidy-14 -p cmake-cache/ -quiet
      1> clang-tidy-errors.log
      2> /dev/null
    - (! egrep -A 3 "error:|warning:|note:" clang-tidy-errors.log)
    - echo "No clang-tidy errors found"

clang-tidy-diff:
  extends: .base-clang-tidy
  except:
    variables:
      - $RELEASE == "weekly"
      - $RELEASE == "daily"
  script:
    - git remote add upstream https://gitlab.com/nsnam/ns-3-dev.git
    - git fetch upstream master
    - git diff -U0 upstream/master HEAD > patch.txt
    - if grep -Fq "b/.clang-tidy" patch.txt ; then
        run-clang-tidy-14 -p cmake-cache/ -quiet
        1> clang-tidy-errors.log
        2> /dev/null;
      else
        cat patch.txt | /usr/lib/llvm-14/share/clang/clang-tidy-diff.py
        -clang-tidy-binary=/usr/bin/clang-tidy-14
        -p1 -path cmake-cache/
        1> clang-tidy-errors.log
        2> /dev/null;
      fi
    - (! egrep -A 3 "error:|warning:|note:" clang-tidy-errors.log)
    - echo "No clang-tidy errors found"

emacs-line:
  stage: code-linting
  image: ubuntu:latest
  script:
    - (! grep -rn --include="*.h" --include="*.cc" "c-file-style:\"gnu\"" ) ||
      (echo "Found Emacs lines on the above C++ files" && exit 1)
    - echo "No Emacs lines found on C++ files"
  timeout: 1h
