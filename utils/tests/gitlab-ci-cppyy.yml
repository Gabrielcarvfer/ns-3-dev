cppyy-22.04:
  image: ubuntu:22.04 # python 3.10
  only:
    variables:
      - $RELEASE == "weekly"
  tags:
    - nsnam
    - linux
  before_script:
    - apt update
    - DEBIAN_FRONTEND=noninteractive apt install -y
      g++ cmake ninja-build ccache
      python3 python3-pip
      libboost-dev libgsl-dev libgtk-3-dev
      git wget
    - pip install cppyy matplotlib numpy
  script:
    - ./ns3 configure -G Ninja --enable-python-bindings
    - ./ns3 build
    - ./ns3 run first.py
    - ./ns3 run second.py
    - ./ns3 run third.py
    - ./ns3 run wifi-ap.py
    - ./ns3 run simple-routing-ping6.py
    - ./ns3 run realtime-udp-echo.py
    - ./ns3 run bianchi11ax.py
    - ./ns3 run sample-simulator.py
    - ./ns3 run "sample-rng-plot.py --not-blocking"
    - ./ns3 run csma-bridge.py
    - ./ns3 run wifi-olsr-flowmon.py
    - ./ns3 run "flowmon-parse-results.py output.xml"
    - ./ns3 run mixed-wired-wireless.py
    - ./ns3 run ./utils/python-unit-tests.py
  timeout: 9h

cppyy-20.04:
  image: ubuntu:20.04 # python 3.8
  only:
    variables:
      - $RELEASE == "manual"
  tags:
    - nsnam
    - linux
  before_script:
    - apt update
    - DEBIAN_FRONTEND=noninteractive apt install -y
      g++ cmake ninja-build ccache
      python3 python3-pip
      libboost-dev libgsl-dev libgtk-3-dev
      git wget
    - pip install cppyy
  script:
    - ./ns3 configure -G Ninja --enable-python-bindings
    - ./ns3 build
    - ./ns3 run first.py
    - ./ns3 run second.py
    - ./ns3 run third.py
    - ./ns3 run ./utils/python-unit-tests.py
  timeout: 9h

cppyy-18.04:
  image: ubuntu:18.04 # python 3.6
  only:
    variables:
      - $RELEASE == "manual"
  tags:
    - nsnam
    - linux
  before_script:
    - apt update
    - apt install -y software-properties-common
    - add-apt-repository ppa:ubuntu-toolchain-r/test -y
    - apt update
    - DEBIAN_FRONTEND=noninteractive apt install -y
      g++-9 gcc-9 cmake ninja-build ccache libclang-dev llvm-dev
      python3 python3-pip
      libboost-dev libgsl-dev libgtk-3-dev
      git wget
    - update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 800 --slave /usr/bin/g++ g++ /usr/bin/g++-9
    - pip3 install cppyy-cling cppyy-backend CPyCppyy cppyy # older python version may install dependencies in the wrong order
  script:
    - CXX=g++-9 ./ns3 configure -G Ninja --enable-python-bindings
    - ./ns3 build
    - ./ns3 run first.py
    - ./ns3 run second.py
    - ./ns3 run third.py
    - ./ns3 run ./utils/python-unit-tests.py
  timeout: 9h

.manylinux-pip-wheel:
  image: quay.io/pypa/manylinux_2_28_x86_64
  only:
    variables:
      - $RELEASE == "manual"
  script:
    # Untar libraries (just to make CMake happy, by we are not going to actually link them)
    # https://github.com/scikit-build/scikit-build/pull/47
    - tar -xvf /opt/_internal/static-libs-for-embedding-only.tar.xz -C /opt/_internal
    # Install minimal toolchain
    - yum install -y libxml2-devel
    # Create Python venv
    - python$PYTHON_VERSION -m venv ./venv
    - . ./venv/bin/activate
    # Upgrade the pip version to reuse the pre-build cppyy
    - python$PYTHON_VERSION -m pip install pip --upgrade
    - python$PYTHON_VERSION -m pip install setuptools --upgrade
    - python$PYTHON_VERSION -m pip install setuptools_scm --upgrade
    - python$PYTHON_VERSION -m pip install wheel auditwheel cmake-build-extension cppyy
    # Configure and build wheel
    - python$PYTHON_VERSION setup.py bdist_wheel build_ext "-DNS3_USE_LIB64=TRUE"
    - export EXCLUDE_INTERNAL_LIBRARIES=`python$PYTHON_VERSION ./build-support/pip-wheel/auditwheel-exclude-list.py`
    #- echo $EXCLUDE_INTERNAL_LIBRARIES
    # Bundle in shared libraries that were not explicitly packaged or depended upon
    - python$PYTHON_VERSION -m auditwheel repair ./dist/*whl -L /lib64 $EXCLUDE_INTERNAL_LIBRARIES
    # Clean the build directory
    - python$PYTHON_VERSION ./ns3 clean
    # Clean up the environment
    - deactivate
    - rm -R ./venv
    # Install wheel
    - python$PYTHON_VERSION -m pip install ./wheelhouse/*whl
    # Test the bindings
    - python$PYTHON_VERSION ./utils/python-unit-tests.py
  timeout: 3h
  artifacts:
    paths:
      - wheelhouse/*.whl
  when: on_success

manylinux-pip-wheel-py3.6:
  extends: .manylinux-pip-wheel
  variables:
    PYTHON_VERSION: '3.6'

manylinux-pip-wheel-py3.7:
  extends: .manylinux-pip-wheel
  variables:
    PYTHON_VERSION: '3.7'

manylinux-pip-wheel-py3.8:
  extends: .manylinux-pip-wheel
  variables:
    PYTHON_VERSION: '3.8'

manylinux-pip-wheel-py3.9:
  extends: .manylinux-pip-wheel
  variables:
    PYTHON_VERSION: '3.9'

manylinux-pip-wheel-py3.10:
  extends: .manylinux-pip-wheel
  variables:
    PYTHON_VERSION: '3.10'

manylinux-pip-wheel-py3.11:
  extends: .manylinux-pip-wheel
  variables:
    PYTHON_VERSION: '3.11'
